# Multi-Arch Build - Sharded Pipeline for Windows
#
# This workflow builds TheRock in stages:
# 1. foundation (generic) - sysdeps, base
# 2. compiler-runtime (generic) - compiler, runtimes
# 3. math-libs (per-arch) - BLAS, FFT, etc.
#
# Stages disabled on Windows: comm-libs, dctools-core, profiler-apps, media
# (see BUILD_TOPOLOGY.toml disable_platforms)
#
# Artifacts flow between stages via S3 using the artifact_manager.py tool.

name: Multi-Arch Build (Windows)

on:
  workflow_call:
    inputs:
      artifact_group:
        type: string
      matrix_per_family_json:
        type: string
        description: "JSON array of {amdgpu_family, test-runs-on} objects for per-arch stages"
      dist_amdgpu_families:
        type: string
        description: "Semicolon-separated list of all GPU families for dist targets"
      build_variant_label:
        type: string
      build_variant_cmake_preset:
        type: string
      build_variant_suffix:
        type: string
      expect_failure:
        type: boolean
      use_prebuilt_artifacts:
        type: string
      rocm_package_version:
        type: string
      test_type:
        type: string

permissions:
  contents: read

jobs:
  # ==========================================================================
  # STAGE: foundation (generic)
  # ==========================================================================
  foundation:
    uses: ./.github/workflows/multi_arch_build_windows_artifacts.yml
    secrets: inherit
    with:
      stage_name: foundation
      stage_display_name: "Stage - Foundation"
      timeout_minutes: 180  # 3 hours
      dist_amdgpu_families: ${{ inputs.dist_amdgpu_families }}
      build_variant_cmake_preset: ${{ inputs.build_variant_cmake_preset }}
      rocm_package_version: ${{ inputs.rocm_package_version }}
    permissions:
      contents: read
      id-token: write

  # ==========================================================================
  # STAGE: compiler-runtime (generic)
  # ==========================================================================
  compiler-runtime:
    needs: foundation
    uses: ./.github/workflows/multi_arch_build_windows_artifacts.yml
    secrets: inherit
    with:
      stage_name: compiler-runtime
      stage_display_name: "Stage - Compiler Runtime"
      timeout_minutes: 480  # 8 hours (compiler is big)
      dist_amdgpu_families: ${{ inputs.dist_amdgpu_families }}
      build_variant_cmake_preset: ${{ inputs.build_variant_cmake_preset }}
      rocm_package_version: ${{ inputs.rocm_package_version }}
    permissions:
      contents: read
      id-token: write

  # ==========================================================================
  # STAGE: math-libs (per-arch)
  # ==========================================================================
  math-libs:
    needs: compiler-runtime
    strategy:
      fail-fast: false
      matrix:
        family_info: ${{ fromJSON(inputs.matrix_per_family_json) }}
    uses: ./.github/workflows/multi_arch_build_windows_artifacts.yml
    secrets: inherit
    with:
      stage_name: math-libs
      stage_display_name: "Stage - Math Libs (${{ matrix.family_info.amdgpu_family }})"
      timeout_minutes: 480  # 8 hours
      amdgpu_family: ${{ matrix.family_info.amdgpu_family }}
      dist_amdgpu_families: ${{ inputs.dist_amdgpu_families }}
      build_variant_cmake_preset: ${{ inputs.build_variant_cmake_preset }}
      rocm_package_version: ${{ inputs.rocm_package_version }}
    permissions:
      contents: read
      id-token: write
